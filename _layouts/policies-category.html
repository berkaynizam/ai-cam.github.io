---
layout: default
---

<!-- Policies Page -->
<section class="policies-page">
    <div class="shapes">
        <div class="light-img">
            {% include icons/home-slider-shape-light.svg %}
        </div>
        <div class="dark-img">
            {% include icons/home-slider-shape-dark.svg %}
        </div>
    </div>
    <div class="container">
        <div class="main-title">
            <h1>{{ page.data.name | default: page.name }}</h1>
            <p>Explore our policies and reports.</p>
        </div>
    </div>
</section>
<!-- Policies Page End -->

<!-- Policies Page Content -->
<section class="policies-page-content">
    <div class="main-shapes shapes-bottom shapes">
        <div class="light-img">
            {% include icons/home-news-shape-light.svg %}
        </div>
        <div class="dark-img">
            {% include icons/home-news-shape-dark.svg %}
        </div>
    </div>
    <div class="container">
        <ul class="list">
            {% if site.policy_categories %}
                {% for category in site.policy_categories %}
                    {% assign category_name = category.data.name | default: category.name %}
                    {% assign page_name = page.data.name | default: page.name %}
                    <li {% if category_name == page_name %}class="active"{% endif %}>
                        <a href="{{ category.url }}">{{ category_name }}</a>
                    </li>
                {% endfor %}
            {% else %}
                {% for category in site.collections.policy_categories.docs %}
                    {% assign category_name = category.data.name | default: category.name %}
                    {% assign page_name = page.data.name | default: page.name %}
                    <li {% if category_name == page_name %}class="active"{% endif %}>
                        <a href="{{ category.url }}">{{ category_name }}</a>
                    </li>
                {% endfor %}
            {% endif %}
        </ul>

        {% assign page_name = page.data.name | default: page.name %}
        {% assign category_content_type = page.data.content_type | default: page.content_type %}
        
        {% if category_content_type == "reports" %}
            <!-- Reports Content -->
            <div class="row" id="reports-container">
                {% assign selected_reports = page.data.selected_reports | default: page.selected_reports %}
                {% if selected_reports and selected_reports.size > 0 %}
                    {% assign total_reports = selected_reports.size %}
                    {% assign initial_limit = 5 %}
                    {% if total_reports < 5 %}
                        {% assign initial_limit = total_reports %}
                    {% endif %}
                    {% for report_slug in selected_reports limit: initial_limit %}
                        {% assign report = site.reports | where: "slug", report_slug | first %}
                        {% if report %}
                        <div class="reports-item" data-report-id="{{ report.slug }}">
                            <div class="shapes">
                                <img src="{{ '/assets/images/materials/news-shape.svg' | relative_url }}" alt="">
                            </div>
                            <div class="row">
                                <div class="col-lg-6">
                                    <div class="text">
                                        <a href="{{ report.url }}"><h3>{{ report.title }}</h3></a>
                                        {% if report.date %}<h6>{{ report.date | date: "%-d %B %Y" }}</h6>{% endif %}
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="description">
                                        {% if report.excerpt %}<p>{{ report.excerpt }}</p>{% endif %}
                                        <a href="{{ report.url }}" class="button"><img src="{{ '/assets/images/icons/arrow-right-up-black.svg' | relative_url }}" alt=""></a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}

                    {% if total_reports > 5 %}
                    <div class="load-more">
                        <a href="javascript:void(0)" id="load-more-btn" data-page="1" data-category="{{ page_name }}" data-selected-reports='{% if selected_reports and selected_reports.size > 0 %}{{ selected_reports | jsonify }}{% else %}[]{% endif %}'>Load more</a>
                    </div>
                    {% endif %}
                {% else %}
                    <div style="height: 400px;"></div>
                {% endif %}
            </div>
        {% else %}
            <!-- Policies Content -->
            <div class="row" id="policies-container">
                {% assign filtered_policies = site.policies | where: 'policy_categories', page_name %}
                {% assign sorted_policies = filtered_policies | sort: 'date' | reverse %}
                {% assign total_policies = sorted_policies | size %}
                {% if total_policies > 0 %}
                    {% assign initial_limit = 5 %}
                    {% if total_policies < 5 %}
                        {% assign initial_limit = total_policies %}
                    {% endif %}
                    {% for policy in sorted_policies limit: initial_limit %}
                        {% if forloop.first %}
                            <div class="col-lg-8" data-policy-id="{{ policy.slug }}">
                                <div class="big-box">
                                    <div class="shapes">
                                        <div class="light-img">
                                            {% include icons/events-item-shape-light.svg %}
                                        </div>
                                        <div class="dark-img">
                                            {% include icons/events-item-shape-dark.svg %}
                                        </div>
                                    </div>
                                    <a href="{{ policy.url }}" class="picture">
                                        <span class="category">{{ policy.policy_categories }}</span>
                                    </a>
                                    <div class="text">
                                        <a href="{{ policy.url }}"><h3>{{ policy.title }}</h3></a>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="col-lg-4" data-policy-id="{{ policy.slug }}">
                                <div class="item">
                                    <div class="shapes">
                                        <div class="light-img">
                                            {% include icons/events-item-shape-light.svg %}
                                        </div>
                                        <div class="dark-img">
                                            {% include icons/events-item-shape-dark.svg %}
                                        </div>
                                    </div>
                                    <a href="{{ policy.url }}" class="picture">
                                        <span class="category">{{ policy.policy_categories }}</span>
                                    </a>
                                    <div class="text">
                                        <div class="top-title">
                                            <a href="{{ policy.url }}"><h3>{{ policy.title }}</h3></a>
                                            <a href="{{ policy.url }}" class="button"><img src="{{ '/assets/images/icons/arrow-right-up-black.svg' | relative_url }}" alt=""></a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}

                    {% if total_policies > 5 %}
                    <div class="col-lg-12">
                        <div class="load-more">
                            <a href="javascript:void(0)" id="load-more-btn" data-page="1" data-category="{{ page_name }}">Load more</a>
                        </div>
                    </div>
                    {% endif %}
                {% else %}
                    <div style="height: 400px;"></div>
                {% endif %}
            </div>
        {% endif %}
    </div>
</section>
<!-- Policies Page Content End -->

{% if category_content_type == "reports" %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const loadMoreBtn = document.getElementById('load-more-btn');
    const reportsContainer = document.getElementById('reports-container');
    let currentPage = 1;
    const itemsPerPage = 5;
    let allReports = [];
    
    // Calculate the number of items displayed on initial load
    const initialItems = document.querySelectorAll('#reports-container [data-report-id]');
    let displayedCount = initialItems.length;

    // Get selected_reports list
    let selectedReports = [];
    if (loadMoreBtn) {
        try {
            const selectedReportsData = loadMoreBtn.getAttribute('data-selected-reports');
            if (selectedReportsData) {
                selectedReports = JSON.parse(selectedReportsData);
            }
        } catch (e) {
            console.error('Error parsing selected reports:', e);
            selectedReports = [];
        }
    }

    // Load all reports from JSON and filter by selected_reports
    if (loadMoreBtn && selectedReports.length > 0) {
        fetch('/reports.json')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.text();
            })
            .then(text => {
                try {
                    const data = JSON.parse(text);
                    const allReportsData = Array.isArray(data) ? data : [];
                    
                    // Find reports in selected_reports list
                    allReports = allReportsData.filter(report => {
                        return selectedReports.some(selected => {
                            // Match by slug or title
                            return report.slug === selected || report.title === selected;
                        });
                    });
                    
                    // Sort by date (newest first)
                    allReports.sort((a, b) => {
                        if (!a.report_date) return 1;
                        if (!b.report_date) return -1;
                        return new Date(b.report_date) - new Date(a.report_date);
                    });
                    
                    // Hide load more button if there are 5 or fewer items
                    if (allReports.length <= 5) {
                        const loadMoreDiv = loadMoreBtn.closest('.load-more');
                        if (loadMoreDiv) {
                            loadMoreDiv.style.display = 'none';
                        }
                    }
                } catch (e) {
                    console.error('Error parsing JSON:', e, 'Response text:', text);
                    allReports = [];
                }
            })
            .catch(error => console.error('Error loading reports:', error));

        // When load more button is clicked
        loadMoreBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            if (allReports.length === 0) {
                fetch('/reports.json')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.text();
                    })
                    .then(text => {
                        try {
                            const data = JSON.parse(text);
                            const allReportsData = Array.isArray(data) ? data : [];
                            
                            // Find reports in selected_reports list
                            allReports = allReportsData.filter(report => {
                                return selectedReports.some(selected => {
                                    return report.slug === selected || report.title === selected;
                                });
                            });
                            
                            // Sort by date (newest first)
                            allReports.sort((a, b) => {
                                if (!a.report_date) return 1;
                                if (!b.report_date) return -1;
                                return new Date(b.report_date) - new Date(a.report_date);
                            });
                            loadMoreReports();
                        } catch (e) {
                            console.error('Error parsing JSON:', e, 'Response text:', text);
                            allReports = [];
                        }
                    })
                    .catch(error => console.error('Error loading reports:', error));
            } else {
                loadMoreReports();
            }
        });
    }

    function formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        const day = date.getDate();
        const month = months[date.getMonth()];
        const year = date.getFullYear();
        return `${day} ${month} ${year}`;
    }

    function loadMoreReports() {
        if (!loadMoreBtn || !reportsContainer) return;
        
        // Check remaining item count
        const remainingReports = allReports.length - displayedCount;
        const reportsToLoad = Math.min(itemsPerPage, remainingReports);
        
        if (reportsToLoad <= 0) {
            const loadMoreDiv = loadMoreBtn.closest('.load-more');
            if (loadMoreDiv) {
                loadMoreDiv.style.display = 'none';
            }
            return;
        }
        
        const nextReports = allReports.slice(displayedCount, displayedCount + reportsToLoad);
        
        if (nextReports.length === 0) {
            const loadMoreDiv = loadMoreBtn.closest('.load-more');
            if (loadMoreDiv) {
                loadMoreDiv.style.display = 'none';
            }
            return;
        }

        // Find load more div
        const loadMoreDiv = loadMoreBtn.closest('.load-more');

        nextReports.forEach((report) => {
            const formattedDate = formatDate(report.report_date);
            
            const html = `
                <div class="reports-item" data-report-id="${report.slug}">
                    <div class="shapes">
                        <img src="/assets/images/materials/news-shape.svg" alt="">
                    </div>
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="text">
                                <a href="${report.url}"><h3>${report.title || ''}</h3></a>
                                ${formattedDate ? `<h6>${formattedDate}</h6>` : ''}
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="description">
                                ${report.excerpt ? `<p>${report.excerpt}</p>` : ''}
                                <a href="${report.url}" class="button"><img src="/assets/images/icons/arrow-right-up-black.svg" alt=""></a>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Insert before load more button
            if (loadMoreDiv && loadMoreDiv.parentNode) {
                loadMoreDiv.insertAdjacentHTML('beforebegin', html);
            } else {
                reportsContainer.insertAdjacentHTML('beforeend', html);
            }
            
            // Find newly added item
            const newItem = reportsContainer.querySelector(`[data-report-id="${report.slug}"]`);
            const newItemShapes = newItem ? newItem.querySelector('.shapes') : null;
            
            if (newItemShapes && 'IntersectionObserver' in window) {
                const reportsItemObserverOptions = {
                    root: null,
                    rootMargin: '0% 0% -20% 0%',
                    threshold: 0
                };
                const reportsItemObserverCallback = function(entries) {
                    entries.forEach(function(entry) {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('in-view');
                            reportsItemObserver.unobserve(entry.target);
                        }
                    });
                };
                const reportsItemObserver = new IntersectionObserver(reportsItemObserverCallback, reportsItemObserverOptions);
                reportsItemObserver.observe(newItemShapes);
            }
            
            // Fade-in animation with GSAP - with ScrollTrigger
            if (newItem && typeof gsap !== 'undefined') {
                gsap.set(newItem, { opacity: 0, y: 50, scale: 0.95 });
                
                gsap.to(newItem, {
                    opacity: 1,
                    y: 0,
                    scale: 1,
                    duration: 0.8,
                    ease: "power3.out",
                    scrollTrigger: {
                        trigger: newItem,
                        start: "top 85%",
                        toggleActions: "play none none none",
                        once: true
                    }
                });
            }
        });

        displayedCount += nextReports.length;
        currentPage++;

        if (displayedCount >= allReports.length) {
            if (loadMoreDiv) {
                loadMoreDiv.style.display = 'none';
            }
        }
    }
});
</script>
{% endif %}
